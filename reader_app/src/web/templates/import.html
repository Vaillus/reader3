<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import from Kobo</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 40px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .back-link { font-size: 0.6em; text-decoration: none; color: #666; }
        
        .loading { text-align: center; padding: 40px; color: #666; font-size: 1.2em; }
        
        .book-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        
        .book-item { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 15px; }
        .book-cover { width: 80px; height: 120px; background: #eee; object-fit: cover; border-radius: 4px; }
        .book-info { flex: 1; overflow: hidden; }
        
        .book-title { font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .book-status { font-size: 0.8em; color: #888; margin-bottom: 10px; }
        
        .btn { border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            Import from Kobo
            <a href="/" class="back-link">← Back to Library</a>
        </h1>

        <div id="loading" class="loading">Fetching books from Kobo...</div>
        <div id="book-list" class="book-list" style="display: none;"></div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        async function loadBooks() {
            try {
                const response = await fetch('/api/kobo/books');
                const books = await response.json();
                
                const container = document.getElementById('book-list');
                container.innerHTML = '';
                
                if (!books || books.length === 0) {
                    document.getElementById('loading').innerText = 'No books found in your Kobo library.';
                    return;
                }
                
                books.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-item';
                    
                    const title = book.title || 'Untitled';
                    const author = book.author || 'Unknown Author';
                    const coverSrc = book.cover_image || 'https://via.placeholder.com/80x120?text=No+Cover';
                    const status = book.is_read ? 'Read' : 'Unread';
                    const format = book.format || 'EPUB';
                    const bookId = book.id || '';
                    
                    div.innerHTML = `
                        <img src="${coverSrc}" class="book-cover" onerror="this.src='https://via.placeholder.com/80x120?text=No+Cover'">
                        <div class="book-info">
                            <div class="book-title" title="${title}">${title}</div>
                            <div class="book-author">${author}</div>
                            <div class="book-status">${status} • ${format}</div>
                            <button class="btn btn-primary" onclick="importBook(this, '${bookId}')">
                                Import Book
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('loading').style.display = 'none';
                container.style.display = 'grid';
                
            } catch (err) {
                console.error('Error loading books:', err);
                document.getElementById('loading').innerText = 'Error loading books: ' + err.message;
            }
        }

        async function importBook(btn, bookId) {
            const originalText = btn.innerText;
            btn.innerText = 'Importing...';
            btn.disabled = true;
            
            try {
                const res = await fetch(`/api/kobo/import/${bookId}`, { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showToast(`✅ Imported: ${data.title}`);
                    btn.innerText = 'Imported';
                    btn.style.background = '#2ecc71';
                } else {
                    throw new Error(data.detail || 'Import failed');
                }
            } catch (err) {
                showToast(`❌ Error: ${err.message}`);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        loadBooks();
    </script>
</body>
</html>

